import*as y from"./three/three.module.min.js";var w=1e-4;function M(r,o,e){if(!r)throw e instanceof Function&&e(),new Error(o||"assert")}function P(r){return M(r&&r.length>=3),Math.floor(Math.atan2(r[2],r[0])*180/Math.PI+.001)}function z(r,o){let e=P(r),t=P(o);return e>t&&e-t>180?e-=360:t>e&&t-e>180&&(t-=360),e>t?1:e<t?-1:0}function k(r,o){return-z(r,o)}function D(r,o){M(r&&r.length>=2);let e=r[1],t=o[1];return e>t?1:e<t?-1:0}function K(r,o){return-D(r,o)}function _(r,o){return M(r&&r.length>=3),M(o&&o.length>=3),Math.sqrt((r[0]-o[0])*(r[0]-o[0])+(r[2]-o[2])*(r[2]-o[2]))}function V(r,o){let{h0:e,v1:t,h1:h,v0:c}=r,s=e.length;return o.to-o.from<360&&(r.v1.length==0||r.v0.length==0)&&console.error(o,r),s>2&&t.length>0&&_(e[0],t[0])<_(e[s-1],t[0])&&e.reverse(),h.length>2&&c.length>0&&_(h[0],c[0])<_(h[s-1],c[0])&&h.reverse(),e.concat(t).concat(h).concat(c)}function I(r,o){M(r&&r.length>0),M(r[0].length>=3);let e=[];for(let s=0;s<r.length;s++)e.push(...r[s]);let t=r.length,h=[];for(let s=0;s<t;s++)s+1!=t&&(o?h.push(s,t,s+1):h.push(s,s+1,t));o?h.push(t-1,t,0):h.push(t-1,0,t),e.push(0,0,0);let c=new y.BufferGeometry;return c.setAttribute("position",new y.BufferAttribute(new Float32Array(e),3)),c.setIndex(h),c.computeVertexNormals(),c}function F(r,o){let{lon:e,lat:t,faceOnly:h}=o;M(!!e&&!!t),M(r>0),M(e.from!==void 0&&e.to!==void 0),M(t.from!==void 0&&t.to!==void 0),M(e.n>0&&t.n>0,[e.n,t.n].join(", "));let c=new Array,s=Math.PI/180,v=new y.SphereGeometry(r,e.n,t.n,e.from*s,(e.to-e.from)*s,t.from*s,(t.to-t.from)*s);if(c.push(v),h)return c;v.computeBoundingBox();let B=v.boundingBox,O=v.getAttribute("position").array,R=O.length,x=new Array,i={h0:x,h1:x.slice(0),v0:x.slice(0),v1:x.slice(0)};M(R>=3);let f=new Array,j=180/Math.PI;for(let g=0;g<R;g+=3){let l=O.slice(g,g+3),a=!1;if(Math.abs(l[1]-B.min.y)<w?t.to<360&&(i.h0.push(l),a=!0):Math.abs(l[1]-B.max.y)<w&&t.from>0&&(i.h1.push(l),a=!0),!a){let n=Math.round(Math.atan2(l[2],l[0])*j*100)/100;f.push([n%360,l])}}if(M(f.length>0),f.length>0){f.sort((a,n)=>a[0]>n[0]?1:a[0]<n[0]?-1:0);let g=f[0][0],l=f[f.length-1][0];if(l-g>180){let a=!1;for(let n=1,u=0;n<f.length;n++){let m=Math.abs(f[n][0]-f[n-1][0]);m>u&&(u>0&&m-u>u/2?(f[n][0]=(f[n][0]-360)%360,a=!0):u=m)}a&&(f.sort((n,u)=>n[0]>u[0]?1:n[0]<u[0]?-1:0),g=f[0][0],l=f[f.length-1][0])}i.v0=f.filter(a=>Math.abs(a[0]-g)<=.01).map(a=>a[1]),i.v1=f.filter(a=>Math.abs(a[0]-l)<=.01).map(a=>a[1])}if(t.from>w?(Math.abs(Math.abs(e.to-e.from)-360)>w?i.v1.sort(D):i.v1=[],i.h0.sort(z)):(i.v0=[],i.v1=[],i.h1=[]),t.to!=180?(Math.abs(Math.abs(e.to-e.from)-360)>w?i.v0.sort(K):i.v0=[],i.h1.sort(k)):(i.v0=[],i.v1=[],i.h0=[]),Math.abs(e.to-e.from-360)<w)return i.h0.length>0&&c.push(I(i.h0,t.from<w)),i.h1.length>0&&c.push(I(i.h1,t.from<w)),c;let d=V(i,e);return M(i.v0.length>0),d.length>0&&c.push(I(d,t.from<w)),c}function C(r,o){M(r>=0);let e=Math.pow(2,r),t=1/(e/2),h=180/Math.PI,c=Math.pow(2,r/3),s=new y.Group,{states:v,material:B,faceOnly:O,xseg:R,yseg:x}=o,i=o.radius||8,f=new Map,j=e/2,d;if(v instanceof Array)d=v;else{let[g,l,a]=[!0,!1,0];Object.Keys(stats).map((n,u)=>{g&&(g=!1,l=n.toString().indexOf(".")>-1),l||(a+=n),d.push({s:u,p:n})}),a>0&&(d=d.map(n=>(n.p=n.p/a,n)))}for(let g=0,l=d.length,a=1-t,n=0;g<l;g++){let u=d[g],m=u.s;if(m===void 0||m>=e||f.get(m))continue;f.set(m,!0);let b=u.p!==void 0?u.p:Math.sqrt((u.i||0)*(u.i||0)+(u.r||0)*(u.r||0)),p=Math.acos(a)*h;if(!b)continue;let H=i*Math.pow(b,1/3)*c,T=m<j,A=F(H,{lon:{from:0,to:360,n:R||32},lat:{from:n,to:p,n:Math.round((x||32)*Math.abs(p-n)/180)},faceOnly:O});for(let E=0;E<A.length;E++)s.add(new y.Mesh(A[E],B));a-=t,n=p}return s}function J(r,o){M(r>=0);let e=Math.pow(2,r),t=1/(e/2),h=180/Math.PI,c=Math.pow(2,r/3),s=new y.Group,{states:v,material:B,faceOnly:O,xseg:R,yseg:x,font:i,twist:f}=o,j=o.radius||8,d=(l,a,n,u)=>{if(!l)return;let m=j*Math.pow(l,1/3)*c,b=F(m,{lon:n,lat:u,faceOnly:O});for(let p=0;p<b.length;p++){let H=new y.Mesh(b[p],B);if(s.add(H),p>0||!i)continue;let T=new y.TextGeometry(a.toString(),{font:i,size:.5,height:.1,curveSegments:3,bevelEnabled:!1}),A=new y.Mesh(T,new y.MeshBasicMaterial({color:2583625728}));b[p].computeBoundingBox();let E=m*Math.sin(u.from/h);A.position.set(E*Math.cos((n.to+n.from)/2/h),m*Math.cos(u.from/h),E*Math.sin((n.to+n.from)/2/h)),s.add(A)}},g=new Map;for(let l=0,a=v.length,n=e-1,u=e/2;l<a;l++){let m=v[l],b=m.s;if(b===void 0||b>=e||g.get(b))continue;g.set(b,!0);let p=b<u,H=m.p!==void 0?m.p:Math.sqrt((m.i||0)*(m.i||0)+(m.r||0)*(m.r||0));if(H<=0)continue;if(b==0||b==n){let S=Math.acos(1-t)*h;S<0&&(S+=360),d(H,b,{from:0,to:360,n:R||32},{from:p?0:180-S,to:p?S:180,n:x||32});continue}let T=Math.floor(Math.log2(p?b:n-b)),A=Math.pow(2,T),E=360/A,q=Math.acos(1-A*t)*h,N=Math.acos(1-2*A*t)*h,G=p&&f?(T+b%A)*E%360:(T+A-b%A)*E%360;d(H,b,{from:p&&f?G:G-E,to:p&&f?G+E:G,n:Math.round((R||32)*E/360)},{from:p?q:180-N,to:p?N:180-q,n:Math.round((x||32)*Math.abs(N-q)/180)})}return s}globalThis.THREE=y;export{F as seg,C as torus,J as view};
