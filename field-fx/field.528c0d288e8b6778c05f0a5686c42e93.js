Array.from(document.querySelectorAll("canvas.field-fx")).forEach(e=>G(e));globalThis.fieldFx=G;globalThis.dispatchEvent(new CustomEvent("field-fx-ready"));function G(e,i){let a={gk:1,exp:2,tension:.25,stroke:1,zoom:1,nearest:.1,sampling:8};i&&(i.gk&&(a.gk=i.gk),i.exp&&(a.exp=i.exp),i.nearest&&(a.nearest=i.nearest),i.sampling&&(a.sampling=i.sampling),i.tension&&(a.tension=i.tension));let M=12,s="99",f=()=>{let l=e.dataset,{origin:g,src:w="/img/mindon.png",rgb:v="",unit:C="8",stroke:y=(a.stroke||1).toString(),zoom:u=(a.zoom||1).toString(),area:z="",nearest:D=(a.nearest||0).toString(),sampling:q=(a.sampling||8).toString()}=l;return a.stroke=parseFloat(y)||1,a.zoom=parseFloat(u)||1,{showOrigin:g!==void 0,src:w,rgb:v,nearest:parseFloat(D)||0,sampling:parseInt(q,10)||parseInt(C,10)||4,area:z&&/^\d+(,\d+){3}$/.test(z)?z.split(",").map(R=>parseInt(R,10)):void 0}},{showOrigin:m,src:h,rgb:t,area:n,sampling:o}=f(),r=e.getContext("2d");r?.clearRect(0,0,e.width,e.height);let d,[c,x,p]=[0,0,0];if(!r)return;r.imageSmoothingEnabled=!0;let E,k=document.createElement("canvas"),b=new Image,I=()=>{if(!r)return;r.clearRect(0,0,e.width,e.height);let[l,g]=[b.naturalWidth,b.naturalHeight];if(!n&&(l>960||g>960)){let A=Math.max(l/562,g/562);n=[0,0,l/A,g/A]}n&&([l,g]=n.slice(2)),[c,x,p]=[l/2,g/2,Math.sqrt((l/2)**2+(g/2)**2)],E={ctx:r,cx:c,cy:x,feature:a},e.width=l*(a.zoom||1),e.height=g*(a.zoom||1);let[w,v]=[Math.round(l/o),Math.round(g/o)];k.width=w,k.height=v;let C=k.getContext("2d");if(!C)return;let[y,u]=[0,0];n&&([y,u]=n.slice(0,2));let z={width:n?l:b.width,height:n?g:b.height};C.drawImage(b,y,u,z.width,z.height,0,0,w,v);let D=C.getImageData(0,0,w,v).data;if(m){let A=e.parentElement?.querySelector("canvas.field-origin");A||(A=k,A.className=="field-origin",e.parentElement?.appendChild(A))}let q=[],R=[],$=[],j=[],W=[],B=[];for(let A=0;A<v;A++){let S=[];for(let F=0;F<w;F++)S.push([F,A]);B.push(S)}W=Q(B),W.forEach(([A,S])=>{let[F,H,T]=[A*o,S*o,4*(S*w+A)],L=(D?.[T+3]||0)/255,N={x:F,y:H,v:(255-(D?.[T]||0))*L},_={x:F,y:H,v:(255-(D?.[T+1]||0))*L},J={x:F,y:H,v:(255-(D?.[T+2]||0))*L};j.push({x:F,y:H,v:(255-((D?.[T]||0)*.299+(D?.[T+1]||0)*.587+(D?.[T+2]||0)*.114))*L}),q.push(N),R.push(_),$.push(J)}),d={red:q,green:R,blue:$,lightness:j},P()};b.crossOrigin="anonymous",b.addEventListener("load",I),h&&(b.src=h);let P=()=>{if(!r||!E)return;r.clearRect(0,0,e.width,e.height);let{red:l,green:g,blue:w,lightness:v}=d,C=Math.floor(p/o),y=10;if(r.lineWidth=a.stroke||1,/[rR*]/.test(t)){r.beginPath(),r.strokeStyle=`#ff0000${s}`;for(let u=0;u<C;u++)O(E,y+u*o,M,l);r.stroke()}if(/[gG*]/.test(t)){r.beginPath(),r.strokeStyle=`#008800${s}`;for(let u=0;u<C;u++)O(E,y+u*o,M,g);r.stroke()}if(/[bB*]/.test(t)){r.beginPath(),r.strokeStyle=`#0000ff${s}`;for(let u=0;u<C;u++)O(E,y+u*o,M,w);r.stroke()}if(!t||/[#*]/.test(t)){r.beginPath(),r.strokeStyle="#000000";for(let u=0;u<C;u++)O(E,y+u*o,M,v);r.stroke()}};e.reload=()=>{({showOrigin:m,src:h,rgb:t,sampling:o,area:n}=f()),h!=b.src?b.src=h:I()},e.draw=P,e.stop=function(){this.playing&&clearTimeout(this.playing),this.dispatchEvent(new CustomEvent("stop"))},e.play=function(l,g=!0){if(l?this.clips=l:l=this.clips,!l||!l.length)throw new Error("clips required");this.playing&&clearTimeout(this.playing);let w=0,v=l.length,C=()=>{if(!l||w>=v&&(w=0,this.dispatchEvent(new CustomEvent("fin")),!g))return;let y=l[w++];y.src&&(h=y.src),y.rgb&&(t=y.rgb),y.area&&y.area.length===4&&(n=y.area),h!=b.src?b.src=h:I(),this.playing=setTimeout(C,(y.dur||.3)*1e3)};C()}}function O(e,i,a,M){let s=a*Math.PI/180,{ctx:f,cx:m,cy:h,feature:t}=e,n=Array.from(Array(Math.ceil(360/a)).keys()).map(c=>{let x={x:m+i*Math.cos(s*c),y:h-i*Math.sin(s*c)},p={x:x.x,y:x.y};return M?.forEach(E=>{let k=K(E,E.v||0,p,t);p.x+=k.x,p.y+=k.y}),p}),{zoom:o=1,tension:r=.25}=t,d=n.map(c=>[o*c.x,o*c.y]);f&&U(f,d,r)}function K(e,i,a,M){let{x:s,y:f}=e,m=a.x,h=a.y,{gk:t=1,exp:n=2,nearest:o=0}=M,r=Math.sqrt((s-m)**2+(f-h)**2),d=t*i/r**n,c=s===m?f>h?Math.PI/2:-Math.PI/2:Math.atan((f-h)/(s-m));f===h?c=s<m?Math.PI:0:s<m&&(c-=Math.PI);let x={x:d*Math.cos(c),y:d*Math.sin(c)},p=Math.min(Math.max(0,1-o),1);return Math.abs(x.x)>Math.abs(e.x-a.x)*p&&(x.x=(e.x-a.x)*p),Math.abs(x.y)>Math.abs(e.y-a.y)*p&&(x.y=(e.y-a.y)*p),x}function Q(e,i=!0){let[a,M]=[e.length,e[0].length],s=e.map(r=>r.map(d=>!1)),f=[],m=[0,1,0,-1],h=[1,0,-1,0],[t,n,o]=[0,0,0];for(let r=0;r<a*M;r++){f.push(e[t][n]),s[t][n]=!0;let[d,c]=[t+m[o],n+h[o]];0<=d&&d<a&&0<=c&&c<M&&!s[d][c]?[t,n]=[d,c]:(o=(o+1)%4,[t,n]=[t+m[o],n+h[o]])}return i?f.reverse():f}function U(e,i,a,M=!0){a=a||.25;let s=i.length;if(s<2)return;if(e.beginPath(),s===2){e.moveTo(i[0][0],i[0][1]),e.lineTo(i[1][0],i[1][1]),e.stroke();return}let f=(t,n)=>Math.sqrt(t*t+n*n),m=[];i.forEach(function(){m.push({cp:[],cn:[]})});for(let t=0;t<s;t++){let n=i[t],o=i[t-1<0?s+t-1:t-1],r=i[t+1>s-1?(t+1)%s:t+1],d=r[0]-o[0],c=r[1]-o[1],x=f(d,c),p=d/x,E=c/x,k=f(n[0]-o[0],n[1]-o[1]),b=f(n[0]-r[0],n[1]-r[1]),I=n[0]-p*k*a,P=n[1]-E*k*a,l=n[0]+p*b*a,g=n[1]+E*b*a;m[t]={cp:[I,P],cn:[l,g]}}e.moveTo(i[0][0],i[0][1]);let h=M?s+1:s;for(let t=1;t<h;t++){let n=i[t%s],o=m[t%s],r=m[t-1];e.bezierCurveTo(r.cn[0],r.cn[1],o.cp[0],o.cp[1],n[0],n[1])}e.stroke()}export{G as fieldFx};
