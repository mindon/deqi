Array.from(document.querySelectorAll("canvas.field-fx")).forEach(r=>W(r));globalThis.fieldFx=W;globalThis.dispatchEvent(new CustomEvent("field-fx-ready"));function W(r,i){let o={g:1,k:1,z:2,tension:.25,stroke:1,zoom:1};i&&(i.g&&(o.g=i.g),i.k&&(o.k=i.k),i.z&&(o.z=i.z),i.tension&&(o.tension=i.tension));let x=12,c="99";function y(){let f=r.dataset,{origin:b,src:A="/img/mindon.png",rgb:z="",unit:k="8",stroke:d="1",zoom:h="1",area:w=""}=f;return o.stroke=parseFloat(d)||1,o.zoom=parseFloat(h)||1,{showOrigin:b!==void 0,src:A,rgb:z,beta:parseInt(k,10)||8,area:w&&/^\d+(,\d+){3}$/.test(w)?w.split(",").map(S=>parseInt(S,10)):void 0}}let{showOrigin:m,src:u,rgb:e,beta:n,area:a}=y(),t=r.getContext("2d");t?.clearRect(0,0,r.width,r.height);let g,[s,p,D]=[0,0,0];if(!t)return;t.imageSmoothingEnabled=!0;let l=new Image;l.crossOrigin="anonymous",l.addEventListener("load",I);let M,F=document.createElement("canvas");u&&(l.src=u);function I(){if(!t)return;t.clearRect(0,0,r.width,r.height);let[f,b]=[l.width,l.height];if(!a&&(f>960||b>960)){let E=Math.max(f/562,b/562);a=[0,0,f/E,b/E]}a&&([f,b]=a.slice(2)),[s,p,D]=[f/2,b/2,Math.sqrt((f/2)**2+(b/2)**2)],M={ctx:t,cx:s,cy:p,feature:o},r.width=f*(o.zoom||1),r.height=b*(o.zoom||1);let[A,z]=[Math.round(f/n),Math.round(b/n)];F.width=A,F.height=z;let k=F.getContext("2d"),[d,h]=[0,0];a&&([d,h]=a.slice(0,2)),k?.drawImage(l,d,h,a?f:l.width,a?b:l.height,0,0,A,z),m&&(l.width=f,l.height=b,r.parentElement?.appendChild(l));let w=k?.getImageData(0,0,A,z).data,S=[],L=[],H=[],j=[],B=[],G=[];for(let E=0;E<z;E++){let T=[];for(let C=0;C<A;C++)T.push([C,E]);G.push(T)}B=Q(G),B.forEach(([E,T])=>{let[C,q,v]=[E*n,T*n,4*(T*A+E)],O=(w?.[v+3]||0)/255,_={x:C,y:q,v:(255-(w?.[v]||0))*O},J={x:C,y:q,v:(255-(w?.[v+1]||0))*O},K={x:C,y:q,v:(255-(w?.[v+2]||0))*O};j.push({x:C,y:q,v:(255-((w?.[v]||0)*.299+(w?.[v+1]||0)*.587+(w?.[v+2]||0)*.114))*O}),S.push(_),L.push(J),H.push(K)}),g={red:S,green:L,blue:H,lightness:j},R()}function R(){if(!t||!M)return;t.clearRect(0,0,r.width,r.height);let{red:f,green:b,blue:A,lightness:z}=g,k=Math.floor(D/n),d=10;if(t.lineWidth=o.stroke||1,/[rR*]/.test(e)){t.beginPath(),t.strokeStyle=`#ff0000${c}`;for(let h=0;h<k;h++)$(M,d+h*n,x,f);t.stroke()}if(/[gG*]/.test(e)){t.beginPath(),t.strokeStyle=`#008800${c}`;for(let h=0;h<k;h++)$(M,d+h*n,x,b);t.stroke()}if(/[bB*]/.test(e)){t.beginPath(),t.strokeStyle=`#0000ff${c}`;for(let h=0;h<k;h++)$(M,d+h*n,x,A);t.stroke()}if(!e||/[#*]/.test(e)){t.beginPath(),t.strokeStyle="#000000";for(let h=0;h<k;h++)$(M,d+h*n,x,z);t.stroke()}}r.reload=()=>{({showOrigin:m,src:u,rgb:e,beta:n,area:a}=y()),u!=l.src?l.src=u:I()},r.draw=R;let P;r.play=(f,b=!0)=>{P&&clearTimeout(P);let A=0,z=f.length,k=()=>{if(A>=z&&(A=0,!b))return;let d=f[A++];d.src&&(u=d.src),d.rgb&&(e=d.rgb),d.area&&d.area.length===4&&(a=d.area),u!=l.src?l.src=u:I(),P=setTimeout(k,(d.dur||.3)*1e3)};k()}}function $(r,i,o,x){let c=o*Math.PI/180,{ctx:y,cx:m,cy:u,feature:e}=r,n=Array.from(Array(Math.ceil(360/o)).keys()).map(s=>{let p={x:m+i*Math.cos(c*s),y:u-i*Math.sin(c*s)},D={x:p.x,y:p.y};return x?.forEach(l=>{let M=N(l,l.v||0,D,e);D.x+=M.x,D.y+=M.y}),D}),{zoom:a=1,tension:t=.25}=e,g=n.map(s=>[a*s.x,a*s.y]);y&&U(y,g,t)}function N(r,i,o,x){let{x:c,y}=r,m=o.x,u=o.y,{g:e=1,k:n=1,z:a=2}=x,t=Math.sqrt((c-m)**2+(y-u)**2),g=e*i/t**a,s=c===m?y>u?Math.PI/2:-Math.PI/2:Math.atan((y-u)/(c-m));y===u?s=c<m?Math.PI:0:c<m&&(s-=Math.PI);let p={x:g*Math.cos(s)/n,y:g*Math.sin(s)/n};return Math.abs(p.x)>Math.abs(r.x-o.x)&&(p.x=r.x-o.x),Math.abs(p.y)>Math.abs(r.y-o.y)&&(p.y=r.y-o.y),p}function Q(r,i=!0){let[o,x]=[r.length,r[0].length],c=r.map(t=>t.map(g=>!1)),y=[],m=[0,1,0,-1],u=[1,0,-1,0],[e,n,a]=[0,0,0];for(let t=0;t<o*x;t++){y.push(r[e][n]),c[e][n]=!0;let[g,s]=[e+m[a],n+u[a]];0<=g&&g<o&&0<=s&&s<x&&!c[g][s]?[e,n]=[g,s]:(a=(a+1)%4,[e,n]=[e+m[a],n+u[a]])}return i?y.reverse():y}function U(r,i,o,x=!0){o=o||.25;let c=i.length;if(c<2)return;if(r.beginPath(),c===2){r.moveTo(i[0][0],i[0][1]),r.lineTo(i[1][0],i[1][1]),r.stroke();return}let y=(e,n)=>Math.sqrt(e*e+n*n),m=[];i.forEach(function(){m.push({cp:[],cn:[]})});for(let e=0;e<c;e++){let n=i[e],a=i[e-1<0?c+e-1:e-1],t=i[e+1>c-1?(e+1)%c:e+1],g=t[0]-a[0],s=t[1]-a[1],p=y(g,s),D=g/p,l=s/p,M=y(n[0]-a[0],n[1]-a[1]),F=y(n[0]-t[0],n[1]-t[1]),I=n[0]-D*M*o,R=n[1]-l*M*o,P=n[0]+D*F*o,f=n[1]+l*F*o;m[e]={cp:[I,R],cn:[P,f]}}r.moveTo(i[0][0],i[0][1]);let u=x?c+1:c;for(let e=1;e<u;e++){let n=i[e%c],a=m[e%c],t=m[e-1];r.bezierCurveTo(t.cn[0],t.cn[1],a.cp[0],a.cp[1],n[0],n[1])}r.stroke()}export{W as fieldFx};
