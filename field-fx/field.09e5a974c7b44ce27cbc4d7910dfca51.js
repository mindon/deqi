Array.from(document.querySelectorAll("canvas.field-fx")).forEach(r=>G(r));globalThis.fieldFx=G;globalThis.dispatchEvent(new CustomEvent("field-fx-ready"));function G(r,i){let o={g:1,k:1,z:2,tension:.25,stroke:1,zoom:1};i&&(i.g&&(o.g=i.g),i.k&&(o.k=i.k),i.z&&(o.z=i.z),i.tension&&(o.tension=i.tension));let x=12,c="99";function y(){let f=r.dataset,{origin:b,src:A="/img/mindon.png",rgb:z="",unit:k="8",stroke:d="1",zoom:h="1",area:D=""}=f;return o.stroke=parseFloat(d)||1,o.zoom=parseFloat(h)||1,{showOrigin:b!==void 0,src:A,rgb:z,beta:parseInt(k,10)||8,area:D&&/^\d+(,\d+){3}$/.test(D)?D.split(",").map(S=>parseInt(S,10)):void 0}}let{showOrigin:m,src:u,rgb:t,beta:n,area:a}=y(),e=r.getContext("2d");e?.clearRect(0,0,r.width,r.height);let g,[s,p,w]=[0,0,0];if(!e)return;e.imageSmoothingEnabled=!0;let l=new Image;l.crossOrigin="anonymous",l.addEventListener("load",I);let M,F=document.createElement("canvas");u&&(l.src=u);function I(){if(!e)return;e.clearRect(0,0,r.width,r.height);let[f,b]=[l.naturalWidth,l.naturalHeight];if(!a&&(f>960||b>960)){let E=Math.max(f/562,b/562);a=[0,0,f/E,b/E]}a&&([f,b]=a.slice(2)),[s,p,w]=[f/2,b/2,Math.sqrt((f/2)**2+(b/2)**2)],M={ctx:e,cx:s,cy:p,feature:o},r.width=f*(o.zoom||1),r.height=b*(o.zoom||1);let[A,z]=[Math.round(f/n),Math.round(b/n)];F.width=A,F.height=z;let k=F.getContext("2d"),[d,h]=[0,0];a&&([d,h]=a.slice(0,2)),k?.drawImage(l,d,h,a?f:l.width,a?b:l.height,0,0,A,z),m&&(l.width=f,l.height=b,r.parentElement?.appendChild(l));let D=k?.getImageData(0,0,A,z).data,S=[],H=[],L=[],W=[],j=[],B=[];for(let E=0;E<z;E++){let T=[];for(let C=0;C<A;C++)T.push([C,E]);B.push(T)}j=Q(B),j.forEach(([E,T])=>{let[C,q,v]=[E*n,T*n,4*(T*A+E)],O=(D?.[v+3]||0)/255,_={x:C,y:q,v:(255-(D?.[v]||0))*O},J={x:C,y:q,v:(255-(D?.[v+1]||0))*O},K={x:C,y:q,v:(255-(D?.[v+2]||0))*O};W.push({x:C,y:q,v:(255-((D?.[v]||0)*.299+(D?.[v+1]||0)*.587+(D?.[v+2]||0)*.114))*O}),S.push(_),H.push(J),L.push(K)}),g={red:S,green:H,blue:L,lightness:W},R()}function R(){if(!e||!M)return;e.clearRect(0,0,r.width,r.height);let{red:f,green:b,blue:A,lightness:z}=g,k=Math.floor(w/n),d=10;if(e.lineWidth=o.stroke||1,/[rR*]/.test(t)){e.beginPath(),e.strokeStyle=`#ff0000${c}`;for(let h=0;h<k;h++)$(M,d+h*n,x,f);e.stroke()}if(/[gG*]/.test(t)){e.beginPath(),e.strokeStyle=`#008800${c}`;for(let h=0;h<k;h++)$(M,d+h*n,x,b);e.stroke()}if(/[bB*]/.test(t)){e.beginPath(),e.strokeStyle=`#0000ff${c}`;for(let h=0;h<k;h++)$(M,d+h*n,x,A);e.stroke()}if(!t||/[#*]/.test(t)){e.beginPath(),e.strokeStyle="#000000";for(let h=0;h<k;h++)$(M,d+h*n,x,z);e.stroke()}}r.reload=()=>{({showOrigin:m,src:u,rgb:t,beta:n,area:a}=y()),u!=l.src?l.src=u:I()},r.draw=R;let P;r.play=(f,b=!0)=>{P&&clearTimeout(P);let A=0,z=f.length,k=()=>{if(A>=z&&(A=0,!b))return;let d=f[A++];d.src&&(u=d.src),d.rgb&&(t=d.rgb),d.area&&d.area.length===4&&(a=d.area),u!=l.src?l.src=u:I(),P=setTimeout(k,(d.dur||.3)*1e3)};k()}}function $(r,i,o,x){let c=o*Math.PI/180,{ctx:y,cx:m,cy:u,feature:t}=r,n=Array.from(Array(Math.ceil(360/o)).keys()).map(s=>{let p={x:m+i*Math.cos(c*s),y:u-i*Math.sin(c*s)},w={x:p.x,y:p.y};return x?.forEach(l=>{let M=N(l,l.v||0,w,t);w.x+=M.x,w.y+=M.y}),w}),{zoom:a=1,tension:e=.25}=t,g=n.map(s=>[a*s.x,a*s.y]);y&&U(y,g,e)}function N(r,i,o,x){let{x:c,y}=r,m=o.x,u=o.y,{g:t=1,k:n=1,z:a=2}=x,e=Math.sqrt((c-m)**2+(y-u)**2),g=t*i/e**a,s=c===m?y>u?Math.PI/2:-Math.PI/2:Math.atan((y-u)/(c-m));y===u?s=c<m?Math.PI:0:c<m&&(s-=Math.PI);let p={x:g*Math.cos(s)/n,y:g*Math.sin(s)/n};return Math.abs(p.x)>Math.abs(r.x-o.x)&&(p.x=r.x-o.x),Math.abs(p.y)>Math.abs(r.y-o.y)&&(p.y=r.y-o.y),p}function Q(r,i=!0){let[o,x]=[r.length,r[0].length],c=r.map(e=>e.map(g=>!1)),y=[],m=[0,1,0,-1],u=[1,0,-1,0],[t,n,a]=[0,0,0];for(let e=0;e<o*x;e++){y.push(r[t][n]),c[t][n]=!0;let[g,s]=[t+m[a],n+u[a]];0<=g&&g<o&&0<=s&&s<x&&!c[g][s]?[t,n]=[g,s]:(a=(a+1)%4,[t,n]=[t+m[a],n+u[a]])}return i?y.reverse():y}function U(r,i,o,x=!0){o=o||.25;let c=i.length;if(c<2)return;if(r.beginPath(),c===2){r.moveTo(i[0][0],i[0][1]),r.lineTo(i[1][0],i[1][1]),r.stroke();return}let y=(t,n)=>Math.sqrt(t*t+n*n),m=[];i.forEach(function(){m.push({cp:[],cn:[]})});for(let t=0;t<c;t++){let n=i[t],a=i[t-1<0?c+t-1:t-1],e=i[t+1>c-1?(t+1)%c:t+1],g=e[0]-a[0],s=e[1]-a[1],p=y(g,s),w=g/p,l=s/p,M=y(n[0]-a[0],n[1]-a[1]),F=y(n[0]-e[0],n[1]-e[1]),I=n[0]-w*M*o,R=n[1]-l*M*o,P=n[0]+w*F*o,f=n[1]+l*F*o;m[t]={cp:[I,R],cn:[P,f]}}r.moveTo(i[0][0],i[0][1]);let u=x?c+1:c;for(let t=1;t<u;t++){let n=i[t%c],a=m[t%c],e=m[t-1];r.bezierCurveTo(e.cn[0],e.cn[1],a.cp[0],a.cp[1],n[0],n[1])}r.stroke()}export{G as fieldFx};
